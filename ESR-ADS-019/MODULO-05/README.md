# Módulo 5

- Criar um deployment para uma app qualquer;
- Configurar o deployment para instanciar 10 replicas;
- Fazer o deploy; 
- Deixar em um terminal o status do rollout;
- Trocar a versão da image da app;
- Reprovisionar e verificar andamento do rollout;
- Reverter a app para a versão anterior e  verificar o andamento do rollout.

---

Criando um deployment para do nginx com 10 instâncias:

`nginx-deployment.yaml`
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 10
  template:
    metadata:
      labels:
        app: nginx
    spec:
      tolerations:
      - key: "hardware"
        operator: "Equal"
        value: "low"
        effect: "NoExecute"
      containers:
      - name: nginx
        image: nginx:1.28.0
        ports:
        - containerPort: 80
```
Fazendo o deploy:
```console
kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment created
```
Confirmando a versão da imagem do deployment:
```console
kubectl get deployment/nginx-deployment -o=jsonpath="{..image}{'\n'}"
nginx:1.28.0
```
Atualizando a versão do nginx e verificando o andamento do rollout:  
```console
kubectl set image deployments/nginx-deployment nginx=nginx:1.29 && kubectl rollout status deployment nginx-deployment
deployment.apps/nginx-deployment image updated
Waiting for deployment "nginx-deployment" rollout to finish: 0 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 3 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 7 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 7 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 7 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 8 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 8 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 8 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 8 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 9 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 9 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
deployment "nginx-deployment" successfully rolled out
```
Verificado a versão atual
```console
kubectl get deployment/nginx-deployment -o=jsonpath="{..image}{'\n'}"
nginx:1.29.0
```
Fazendo roll back para a versão aterior e verificando o andamento do rollout:
```console
kubectl set image deployments/nginx-deployment nginx=nginx:1.28 && kubectl rollout status deployment nginx-deployment
deployment.apps/nginx-deployment image updated
Waiting for deployment "nginx-deployment" rollout to finish: 3 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 3 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 5 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 6 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 8 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 8 out of 10 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 8 of 10 updated replicas are available...
Waiting for deployment "nginx-deployment" rollout to finish: 9 of 10 updated replicas are available...
deployment "nginx-deployment" successfully rolled out
```
```console
kubectl get deployment/nginx-deployment -o=jsonpath="{..image}{'\n'}"
nginx:1.28.0
```
